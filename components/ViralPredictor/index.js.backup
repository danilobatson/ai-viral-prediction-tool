import {
	VStack,
	HStack,
	Text,
	Textarea,
	Button,
	Box,
	SimpleGrid,
	Stat,
	StatLabel,
	StatNumber,
	StatHelpText,
	Badge,
	Icon,
	useToast,
	Input,
	Card,
	CardBody,
	CardHeader,
	Heading,
	Wrap,
	WrapItem,
	Container,
	Alert,
	AlertIcon,
	AlertDescription,
	Link,
	Divider,
} from '@chakra-ui/react';
import { useState, useRef } from 'react';
import { motion } from 'framer-motion';
import {
	FaHeart,
	FaReply,
	FaShare,
	FaClock,
	FaLightbulb,
	FaHashtag,
	FaTwitter,
	FaBrain,
	FaExternalLinkAlt,
	FaDatabase,
} from 'react-icons/fa';
import { formatNumber } from '../../lib/number-utils';
import TwitterProgress from '../ui/SocialMediaProgress';
import ViralMeter from '../ui/ViralMeter';
import GlassCard from '../ui/GlassCard';
import ConfettiEffect from '../ui/ConfettiEffect';
import ModernHero from '../ui/ModernHero';
import Footer from '../ui/Footer';

const MotionBox = motion(Box);

export default function ViralPredictor() {
	const [content, setContent] = useState('');
	const [creator, setCreator] = useState('');
	const [loading, setLoading] = useState(false);
	const [results, setResults] = useState(null);
	const [error, setError] = useState('');
	const [creatorError, setCreatorError] = useState('');
	const [progressStep, setProgressStep] = useState('');
	const [progressMessage, setProgressMessage] = useState('');
	const [showConfetti, setShowConfetti] = useState(false);
	const predictorRef = useRef(null);
	const toast = useToast();

	const scrollToPredictor = () => {
		predictorRef.current?.scrollIntoView({
			behavior: 'smooth',
			block: 'start'
		});
	};

	const updateProgress = (step, message = '') => {
		console.log(`ğŸ”„ Progress: ${step} - ${message}`);
		setProgressStep(step);
		setProgressMessage(message);
	};

	const handlePredict = async () => {
		if (!content.trim()) {
			toast({
				title: 'Tweet Required',
				description: 'Please enter your original tweet content to analyze',
				status: 'warning',
				duration: 3000,
				isClosable: true,
			});
			return;
		}

		setLoading(true);
		setError('');
		setCreatorError('');
		setResults(null);
		setShowConfetti(false);

		try {
			updateProgress('connecting', 'Reading your original tweet content...');

			if (creator.trim()) {
				updateProgress('fetching', 'Looking up your ğ• profile...');

				const cleanCreator = creator.trim().replace(/^@+/, '');

				try {
					updateProgress('fetching', 'Fetching your follower count and engagement history...');

					const creatorResponse = await fetch('/api/analyze', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ content: content.trim(), creator: creator.trim().replace(/^@+/, "") || undefined }),
					});

					const creatorResult = await creatorResponse.json();

					if (!creatorResult.success) {
						setCreatorError(creatorResult.error);
						updateProgress('fetching', 'Creator lookup failed, using general analysis...');
					} else {
						updateProgress('fetching', 'Account data retrieved! Enhancing analysis...');
					}
				} catch (creatorErr) {
					setCreatorError(`Failed to lookup ğ• account: ${creatorErr.message}`);
					updateProgress('fetching', 'Account lookup failed, continuing with general analysis...');
				}
			}

			updateProgress('analyzing', 'Processing your original tweet with AI...');

			const predictionResponse = await fetch('/api/analyze', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ content: content.trim(), creator: creator.trim().replace(/^@+/, "") || undefined }),
			});

			updateProgress('analyzing', 'Calculating viral probability for your original tweet...');

			const predictionResult = await predictionResponse.json();

			if (!predictionResult.success) {
				throw new Error(predictionResult.error);
			}

			updateProgress('complete', 'Original tweet analysis complete!');
			setResults(predictionResult);

			if (predictionResult.viralProbability >= 70) {
				setTimeout(() => setShowConfetti(true), 500);
			}

			toast({
				title: `${predictionResult.viralProbability}% Viral Potential!`,
				description: predictionResult.hasCreatorData
					? 'ğ• Enhanced with your account analytics'
					: creatorError
						? 'ğŸ“Š General analysis (ğ• lookup failed)'
						: 'ğŸ“Š General original tweet analysis',
				status: predictionResult.viralProbability >= 70 ? 'success' : 'info',
				duration: 5000,
				isClosable: true,
			});

		} catch (err) {
			setError(err.message);
			updateProgress('error', err.message);
			toast({
				title: 'Analysis Failed',
				description: err.message,
				status: 'error',
				duration: 5000,
				isClosable: true,
			});
		} finally {
			setLoading(false);
		}
	};

	const getViralCategoryColor = (category) => {
		switch (category) {
			case 'Ultra High': return 'red'
			case 'High': return 'orange'
			case 'Moderate': return 'yellow'
			case 'Low': return 'gray'
			default: return 'gray'
		}
	};

	const getTwitterEmoji = (probability) => {
		if (probability >= 80) return 'ğŸ”¥';
		if (probability >= 70) return 'ğŸš€';
		if (probability >= 60) return 'ğŸ’«';
		if (probability >= 50) return 'âœ¨';
		return 'ğŸ‘';
	};

	const cleanHandle = (handle) => {
		return handle.trim().replace(/^@+/, '');
	};

	return (
		<Box minH="100vh" bg="gray.50">
			<ConfettiEffect trigger={showConfetti} viralProbability={results?.viralProbability} />

			{/* Modern Hero Section */}
			<ModernHero onScrollToPredictor={scrollToPredictor} />

			{/* Main Content */}
			<Container maxW="6xl" py={20} ref={predictorRef}>
				<VStack spacing={12} align="stretch">
					{/* Input Section */}
					<MotionBox
						initial={{ opacity: 0, y: 50 }}
						whileInView={{ opacity: 1, y: 0 }}
						transition={{ duration: 0.8 }}
						viewport={{ once: true }}
					>
						<GlassCard p={8}>
							<VStack spacing={6}>
								<VStack spacing={2} textAlign="center">
									<Heading size="lg" bgGradient="linear(to-r, gray.700, black)" bgClip="text">
										ğ• Analyze Your Original Tweet
									</Heading>
									<Text color="gray.600">
										Paste your original tweet content and get instant viral predictions. Retweets not supported.
									</Text>
								</VStack>

								<Textarea
									value={content}
									onChange={(e) => setContent(e.target.value)}
									placeholder="Example original tweet:

ğŸš€ Bitcoin just broke through $100K resistance!

The institutional adoption we've been waiting for is finally here. MicroStrategy, Tesla, and now even pension funds are allocating to BTC.

This is just the beginning of the next bull run. ğŸ“ˆ

#Bitcoin #BTC #CryptoBull #ToTheMoon"
									size="lg"
									minH="200px"
									resize="vertical"
									bg="white"
									border="2px solid"
									borderColor="transparent"
									_focus={{
										borderColor: "gray.700",
										boxShadow: "0 0 0 1px gray.700",
									}}
									borderRadius="xl"
								/>

								<HStack w="full" spacing={4}>
									<Input
										value={creator}
										onChange={(e) => setCreator(e.target.value)}
										placeholder="Your ğ• handle: username (no @ needed)"
										size="lg"
										flex={1}
										bg="white"
										border="2px solid"
										borderColor="transparent"
										_focus={{
											borderColor: "gray.700",
											boxShadow: "0 0 0 1px gray.700",
										}}
										borderRadius="xl"
									/>
									<Button
										colorScheme="gray"
										onClick={handlePredict}
										isLoading={loading}
										loadingText="Analyzing..."
										size="lg"
										minW="200px"
										borderRadius="xl"
										bg="black"
										color="white"
										_hover={{
											bg: "gray.800",
											transform: "translateY(-2px)",
											boxShadow: "xl",
										}}
										_active={{
											transform: "translateY(0px)",
										}}
									>
										ğ• Predict Viral Potential
									</Button>
								</HStack>

								{creator.trim() && (
									<Text fontSize="sm" color="gray.500">
										Will analyze: @{cleanHandle(creator)}'s engagement patterns
									</Text>
								)}
							</VStack>
						</GlassCard>
					</MotionBox>

					{/* Loading State */}
					{loading && (
						<MotionBox
							initial={{ opacity: 0, scale: 0.9 }}
							animate={{ opacity: 1, scale: 1 }}
							transition={{ duration: 0.3 }}
						>
							<TwitterProgress
								currentStep={progressStep}
								currentMessage={progressMessage}
								error={error}
							/>
						</MotionBox>
					)}

					{/* Creator Error Warning */}
					{creatorError && !loading && (
						<MotionBox
							initial={{ opacity: 0, scale: 0.9 }}
							animate={{ opacity: 1, scale: 1 }}
							transition={{ duration: 0.3 }}
						>
							<Alert status="warning" borderRadius="lg">
								<AlertIcon />
								<Box>
									<Text fontWeight="bold">ğ• Account Lookup Failed</Text>
									<AlertDescription>
										{creatorError}
									</AlertDescription>
									<Text fontSize="sm" mt={2} color="gray.600">
										Don't worry! We'll still analyze your original tweet content with general patterns.
									</Text>
								</Box>
							</Alert>
						</MotionBox>
					)}

					{/* Results Section */}
					{results && !loading && (
						<MotionBox
							initial={{ opacity: 0, y: 50 }}
							animate={{ opacity: 1, y: 0 }}
							transition={{ duration: 0.8 }}
						>
							<VStack spacing={8}>
								{/* Viral Probability Meter */}
								<GlassCard p={8} textAlign="center">
									<VStack spacing={6}>
										<ViralMeter
											probability={results.viralProbability}
											category={results.viralCategory}
											isAnimating={true}
										/>

										<VStack spacing={2}>
											<HStack spacing={2}>
												<Text fontSize="2xl">
													{getTwitterEmoji(results.viralProbability)}
												</Text>
												<Badge
													colorScheme={getViralCategoryColor(results.viralCategory)}
													fontSize="lg"
													px={4}
													py={2}
													borderRadius="full"
												>
													{results.viralCategory} Viral Potential
												</Badge>
											</HStack>
											<Text color="gray.600">
												{results.hasCreatorData
													? 'âœ… Personalized for your ğ• account'
													: creatorError
														? 'ğŸ“Š General analysis (couldn\'t get account data)'
														: 'ğŸ“Š General original tweet analysis'
												}
											</Text>
										</VStack>
									</VStack>
								</GlassCard>

								{/* Expected ğ• Engagement */}
								{results.hasCreatorData && results.creatorData && (
									<Card bg="white" borderRadius="xl" boxShadow="lg">
										<CardHeader pb={2}>
											<HStack spacing={3}>
												<Icon as={FaTwitter} color="black" boxSize={5} />
												<Heading size="md">Your Expected ğ• Engagement</Heading>
												<Badge colorScheme="blue" fontSize="xs">
													Powered by LunarCrush MCP
												</Badge>
											</HStack>
										</CardHeader>
										<CardBody>
											<SimpleGrid columns={{ base: 2, md: 4 }} spacing={6}>
												{[
													{
														label: 'ğ• Handle',
														value: `@${results.creatorData.handle}`,
														icon: FaTwitter,
														color: 'gray'
													},
													{
														label: 'Followers',
														value: formatNumber(results.creatorData.followers),
														icon: FaHeart,
														color: 'red'
													},
													{
														label: 'Avg Engagement',
														value: formatNumber(results.creatorData.engagements),
														icon: FaReply,
														color: 'green'
													},
													{
														label: 'This Tweet',
														value: formatNumber(results.expectedEngagement),
														icon: FaShare,
														color: 'purple'
													},
												].map((stat, index) => (
													<MotionBox
														key={stat.label}
														initial={{ opacity: 0, y: 20 }}
														animate={{ opacity: 1, y: 0 }}
														transition={{ duration: 0.5, delay: index * 0.1 }}
													>
														<Stat textAlign="center">
															<HStack justify="center" mb={2}>
																<Icon as={stat.icon} color={`${stat.color}.500`} />
															</HStack>
															<StatNumber fontSize="xl" color={`${stat.color}.500`}>
																{stat.value}
															</StatNumber>
															<StatLabel fontSize="sm" color="gray.600">
																{stat.label}
															</StatLabel>
														</Stat>
													</MotionBox>
												))}
											</SimpleGrid>
										</CardBody>
									</Card>
								)}

								{/* ğ• Psychology Analysis */}
								{results.psychologyScore && (
									<Card bg="white" borderRadius="xl" boxShadow="lg">
										<CardHeader pb={2}>
											<HStack spacing={3}>
												<Icon as={FaBrain} color="purple.500" boxSize={5} />
												<Heading size="md">Why People Will Engage on ğ•</Heading>
											</HStack>
										</CardHeader>
										<CardBody>
											<SimpleGrid columns={{ base: 2, md: 4 }} spacing={6}>
												{[
													{
														key: 'emotional',
														label: 'Emotional Impact',
														desc: 'Makes people feel something',
														emoji: 'ğŸ˜'
													},
													{
														key: 'socialCurrency',
														label: 'Share Value',
														desc: 'Worth sharing to followers',
														emoji: 'ğŸ”„'
													},
													{
														key: 'practicalValue',
														label: 'Useful Content',
														desc: 'Helpful or informative',
														emoji: 'ğŸ’¡'
													},
													{
														key: 'story',
														label: 'Story Appeal',
														desc: 'Has narrative hook',
														emoji: 'ğŸ“–'
													},
												].map((item, index) => (
													<MotionBox
														key={item.key}
														initial={{ opacity: 0, scale: 0.8 }}
														animate={{ opacity: 1, scale: 1 }}
														transition={{ duration: 0.5, delay: index * 0.1 }}
													>
														<Stat textAlign="center">
															<Text fontSize="2xl" mb={2}>
																{item.emoji}
															</Text>
															<StatNumber fontSize="3xl" color="purple.500">
																{results.psychologyScore[item.key]}%
															</StatNumber>
															<StatLabel fontWeight="bold">
																{item.label}
															</StatLabel>
															<StatHelpText fontSize="xs">
																{item.desc}
															</StatHelpText>
														</Stat>
													</MotionBox>
												))}
											</SimpleGrid>
										</CardBody>
									</Card>
								)}

								{/* ğ• Tips & Hashtags */}
								<SimpleGrid columns={{ base: 1, lg: 2 }} spacing={8} w="full">
									{/* ğ• Optimization Tips */}
									{results.recommendations && results.recommendations.length > 0 && (
										<Card bg="white" borderRadius="xl" boxShadow="lg">
											<CardHeader pb={2}>
												<HStack spacing={3}>
													<Icon as={FaLightbulb} color="orange.500" boxSize={5} />
													<Heading size="md">How to Get More Engagement</Heading>
												</HStack>
											</CardHeader>
											<CardBody>
												<VStack align="start" spacing={4}>
													{results.recommendations.map((rec, index) => (
														<MotionBox
															key={index}
															initial={{ opacity: 0, x: -20 }}
															animate={{ opacity: 1, x: 0 }}
															transition={{ duration: 0.5, delay: index * 0.1 }}
														>
															<HStack align="start" spacing={3}>
																<Badge colorScheme="orange" borderRadius="full" minW="24px" h="24px" display="flex" alignItems="center" justifyContent="center">
																	{index + 1}
																</Badge>
																<Text fontSize="sm">{rec}</Text>
															</HStack>
														</MotionBox>
													))}
												</VStack>
											</CardBody>
										</Card>
									)}

									{/* Hashtags & Best Times */}
									<VStack spacing={8}>
										{/* Trending Hashtags */}
										{results.optimizedHashtags && results.optimizedHashtags.length > 0 && (
											<Card bg="white" borderRadius="xl" boxShadow="lg" w="full">
												<CardHeader pb={2}>
													<HStack spacing={3}>
														<Icon as={FaHashtag} color="blue.500" boxSize={5} />
														<Heading size="md">Trending Hashtags</Heading>
													</HStack>
												</CardHeader>
												<CardBody>
													<Wrap>
														{results.optimizedHashtags.map((tag, index) => (
															<WrapItem key={index}>
																<MotionBox
																	initial={{ opacity: 0, scale: 0.8 }}
																	animate={{ opacity: 1, scale: 1 }}
																	transition={{ duration: 0.3, delay: index * 0.05 }}
																	whileHover={{ scale: 1.05 }}
																>
																	<Badge
																		colorScheme="blue"
																		variant="outline"
																		fontSize="sm"
																		px={3}
																		py={1}
																		borderRadius="full"
																	>
																		{tag}
																	</Badge>
																</MotionBox>
															</WrapItem>
														))}
													</Wrap>
												</CardBody>
											</Card>
										)}

										{/* Best Tweet Times */}
										{results.optimalTiming && (
											<Card bg="white" borderRadius="xl" boxShadow="lg" w="full">
												<CardHeader pb={2}>
													<HStack spacing={3}>
														<Icon as={FaClock} color="green.500" boxSize={5} />
														<Heading size="md">Best Times to Tweet</Heading>
													</HStack>
												</CardHeader>
												<CardBody>
													<VStack align="start" spacing={3}>
														<HStack>
															<Text fontWeight="bold" color="green.500">ğŸ“… Best Days:</Text>
															<Text>{results.optimalTiming.bestDays}</Text>
														</HStack>
														<HStack>
															<Text fontWeight="bold" color="green.500">ğŸ• Peak Hours:</Text>
															<Text>{results.optimalTiming.bestTime}</Text>
														</HStack>
														<HStack>
															<Text fontWeight="bold" color="green.500">ğŸŒ Time Zone:</Text>
															<Text>{results.optimalTiming.timezone}</Text>
														</HStack>
													</VStack>
												</CardBody>
											</Card>
										)}
									</VStack>
								</SimpleGrid>

								{/* LunarCrush MCP Branding */}
								<Card bg="gray.50" borderRadius="xl" boxShadow="sm">
									<CardBody>
										<VStack spacing={4} textAlign="center">
											<Divider />
											<HStack spacing={3}>
												<Icon as={FaDatabase} color="blue.500" boxSize={5} />
												<VStack spacing={1} align="start">
													<Text fontWeight="bold" color="gray.800">
														Powered by LunarCrush MCP
													</Text>
													<Text fontSize="sm" color="gray.600">
														Real-time social data via Model Context Protocol
													</Text>
												</VStack>
												<Link
													href="https://lunarcrush.com/developers/api/endpoints"
													isExternal
													color="blue.500"
													fontSize="sm"
													fontWeight="medium"
													display="flex"
													alignItems="center"
													gap={1}
												>
													Learn More <Icon as={FaExternalLinkAlt} boxSize={3} />
												</Link>
											</HStack>
											<HStack spacing={6} fontSize="xs" color="gray.500">
												<Text>âœ… Real Creator Data</Text>
												<Text>ğŸ”„ Live Social Metrics</Text>
												<Text>ğŸ¤– AI-Enhanced Analysis</Text>
												<Text>ğŸ“Š MCP Integration</Text>
											</HStack>
										</VStack>
									</CardBody>
								</Card>
							</VStack>
						</MotionBox>
					)}
				</VStack>
			</Container>

			{/* Professional Footer */}
			<Footer />
		</Box>
	);
}
